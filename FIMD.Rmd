---
title: "Flexible Imputation of Missing Data"
author: "Stef van Buuren"
date: "`r Sys.Date()`"
output:
  md_document:
    variant: markdown_github
bibliography: refs.bibtex
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include=FALSE} 
knitr::opts_chunk$set(echo = TRUE, fig.height = 4.42, fig.width = 6.63, 
                      tidy = TRUE, fig.retina = 2, cache = TRUE)
options(digits = 3, width = 55)
set.seed(92622)
```

This page contains the R code from the book *Flexible Imputation of Missing Data* [@vanbuuren2012].

### Chapter 1 	Introduction

### Section 1.1 The problem of missing data

```{r}
### calculate the mean of three numbers
y <- c(1, 2, 4)
mean(y)

### calculate the mean of three numbers, where one is
### missing
y <- c(1, 2, NA)
mean(y)

### repeat, but with any missing data removed
mean(y, na.rm = TRUE)

### store your current options (safety measure)
youroptions <- options()

### demo regression that generates an error message
### using default na.fail
options(na.action = na.fail)

### uncomment to see the error 
### lm(Ozone ~ Wind, data = airquality)

### remove incomplete observations by 'na.action =
### na.omit'
fit <- lm(Ozone ~ Wind, data = airquality, na.action = na.omit)
coef(fit)

### set automatic na.action = na.omit
options(na.action = na.omit)

### find out how many rows were deleted
deleted <- na.action(fit)
naprint(deleted)

### more incomplete rows if we add Solar.R as
### predictor
fit2 <- lm(Ozone ~ Wind + Solar.R, data = airquality)
naprint(na.action(fit2))

### restore your original options, but set na.omit
options(youroptions)
options(na.action = na.omit)
```

### Section 1.3.2 Pairwise deletion

```{r}
### note: mean(<data.frame>) is deprecated
colMeans(airquality, na.rm = TRUE)
cor(airquality, use = "pair")
cov(airquality, use = "pair")
```

### Section 1.3.3 Mean imputation

```{r}
library("mice")
library("lattice")

### impute the mean
imp <- mice(airquality, method = "mean", m = 1, maxit = 1)


### Figure 1.1
lwd <- 1.5
par(mfrow = c(1, 2))
breaks <- seq(-20, 200, 10)
nudge <- 1
x <- matrix(c(breaks - nudge, breaks + nudge), ncol = 2)
obs <- airquality[, "Ozone"]
mis <- imp$imp$Ozone[, 1]
fobs <- c(hist(obs, breaks, plot = FALSE)$counts, 0)
fmis <- c(hist(mis, breaks, plot = FALSE)$counts, 0)
y <- matrix(c(fobs, fmis), ncol = 2)
matplot(x, y, type = "s", col = c(mdc(4), mdc(5)), 
  lwd = 2, lty = 1, xlim = c(0, 170), ylim = c(0, 
    40), yaxs = "i", xlab = "Ozone (ppb)", ylab = "Frequency")
box()

tp <- xyplot(imp, Ozone ~ Solar.R, na.groups = ici(imp), 
  ylab = "Ozone (ppb)", xlab = "Solar Radiation (lang)", 
  cex = 0.75, lex = lwd, ylim = c(-20, 180), xlim = c(0, 350))
print(tp, newpage = FALSE, position = c(0.48, 0.08, 
  1, 0.92))
```

### Section 1.3.4 Regression imputation

```{r}
fit <- lm(Ozone ~ Solar.R, data = airquality)
pred <- predict(fit, newdata = ic(airquality))

### alternative using mice
imp <- mice(airquality[, 1:2], method = "norm.predict", 
  m = 1, maxit = 3, seed = 1)

### Figure 1.2
par(mfrow = c(1, 2))
fmis <- c(hist(pred, breaks, plot = FALSE)$counts, 0)
y <- matrix(c(fobs, fmis), ncol = 2)
matplot(x, y, type = "s", col = c(mdc(4), mdc(5)), 
  lwd = 2, lty = 1, xlim = c(0, 170), ylim = c(0, 40), 
  yaxs = "i", xlab = "Ozone (ppb)", ylab = "Frequency")
box()

tp <- xyplot(imp, Ozone ~ Solar.R, ylab = "Ozone (ppb)", 
  xlab = "Solar Radiation (lang)", cex = 0.75, lex = lwd, 
  ylim = c(-20, 180), xlim = c(0, 350))
print(tp, newpage = FALSE, position = c(0.48, 0.08, 
  1, 0.92))
```

### Section 1.3.5 Stochastic regression imputation

```{r}
imp <- mice(airquality[, 1:2], method = "norm.nob", 
  m = 1, maxit = 1, seed = 1)

### Figure 1.3
par(mfrow = c(1, 2))
mis <- imp$imp$Ozone[, 1]
fmis <- c(hist(mis, breaks, plot = FALSE)$counts, 0)
y <- matrix(c(fobs, fmis), ncol = 2)
matplot(x, y, type = "s", col = c(mdc(4), mdc(5)), 
  lwd = 2, lty = 1, xlim = c(0, 170), ylim = c(0, 
    40), yaxs = "i", xlab = "Ozone (ppb)", ylab = "Frequency")
box()

tp <- xyplot(imp, Ozone ~ Solar.R, na.groups = ici(imp), 
  ylab = "Ozone (ppb)", xlab = "Solar Radiation (lang)", 
  cex = 0.75, lex = lwd, ylim = c(-20, 180), xlim = c(0, 350))
print(tp, newpage = FALSE, position = c(0.48, 0.08, 
  1, 0.92))
```

### Section 1.3.6 LOCF and BOCF

```{r}
par(mfrow = c(1, 1))
Oz <- airquality$Ozone
locf <- function(x) {
  a <- x[1]
  for (i in 2:length(x)) {
    if (is.na(x[i])) 
      x[i] <- a else a <- x[i]
  }
  return(x)
}
Ozi <- locf(Oz)
colvec <- ifelse(is.na(Oz), mdc(2), mdc(1))

### Figure 1.4

plot(Ozi[1:80], col = colvec, type = "l", xlab = "Day number", 
  ylab = "Ozone (ppb)")
points(Ozi[1:80], col = colvec, pch = 20, cex = 1)
```

### Section 1.4.3 Example of multiple imputation

```{r}
imp <- mice(airquality, seed = 1, print = FALSE)
fit <- with(imp, lm(Ozone ~ Wind + Temp + Solar.R))
tab <- round(summary(pool(fit)), 3)
tab[, c(1:3, 5)]

fit <- lm(Ozone ~ Wind + Temp + Solar.R, data = airquality, 
  na.action = na.omit)
round(coef(summary(fit)), 3)

### Figure 1.6
par(mfrow = c(1, 2))
mis <- imp$imp$Ozone[, 1]
fmis <- c(hist(mis, breaks, plot = FALSE)$counts, 0)
y <- matrix(c(fobs, fmis), ncol = 2)
matplot(x, y, type = "s", col = c(mdc(4), mdc(5)), 
  lwd = 2, lty = 1, xlim = c(0, 170), ylim = c(0, 
    40), yaxs = "i", xlab = "Ozone (ppb)", ylab = "Frequency")
box()

tp <- xyplot(imp, Ozone ~ Solar.R, subset = .imp == 
  1, ylab = "Ozone (ppb)", xlab = "Solar Radiation (lang)", 
  cex = 0.75, lex = lwd, ylim = c(-20, 180), xlim = c(0, 350))
print(tp, newpage = FALSE, position = c(0.48, 0.08, 
  1, 0.92))
```

```{r}
### scatterplot of all imputed data sets (not in book)
xyplot(imp, Ozone ~ Solar.R | .imp, ylab = "Ozone (ppb)", 
  xlab = "Solar Radiation (lang)", cex = 0.75, lex = lwd, 
  ylim = c(-20, 180), xlim = c(0, 350))

### Figure 1.7

Oz <- airquality$Ozone
colvec <- ifelse(is.na(Oz), mdc(2), mdc(1))
par(mfrow = c(1, 1))
plot(Oz[1:80], col = mdc(1), type = "l", xlab = "Day number", 
  ylab = "Ozone (ppb)")
points(Oz[1:80], col = mdc(1), pch = 20, cex = 1)

idx <- ici(airquality$Ozone) & (1:153) < 81
x <- (1:153)[idx]
points(x = x, y = complete(imp, 1)$Ozone[idx], col = mdc(2), 
  pch = 20, cex = 1)
points(x = x, y = complete(imp, 2)$Ozone[idx], col = mdc(2), 
  pch = 20, cex = 1)
points(x = x, y = complete(imp, 3)$Ozone[idx], col = mdc(2), 
  pch = 20, cex = 1)
points(x = x, y = complete(imp, 4)$Ozone[idx], col = mdc(2), 
  pch = 20, cex = 1)
points(x = x, y = complete(imp, 5)$Ozone[idx], col = mdc(2), 
  pch = 20, cex = 1)
```

```{r}
### figure of the autocorrelation function
### (not in the book)

par(mfrow = c(2, 5))
acf.ozone <- with(imp, acf(Ozone))
model <- expression(acf(resid(lm(Ozone ~ Wind + Temp + 
  Solar.R))))
acf.resid <- with(imp, model)
calcacf <- function(acf.list) {
  k <- length(acf.list)
  acc <- acf.list[[1]]$acf
  for (i in 2:k) acc <- acc + acf.list[[i]]$acf
  return(acc/k)
}
oz <- round(calcacf(acf.ozone$analyses), 2)
re <- round(calcacf(acf.resid$analyses), 2)
```


## Chapter 2 Multiple imputation

```{r}
library("mice")
library("lattice")
library("MASS")

### Section 2.1.3 The expanding literature on multiple imputation
### Figure 2.1

cit  <- c(     2010, 37, 182, NA,
               2009, 36, 129, NA,
               2008, 27, 111, NA,
               2007, 35, 136, NA,
               2006, 18, 80, NA,
               2005, 20, 76, NA,
               2004,  6, 56, NA,
               2003, 17, 42, NA,
               2002, 14, 40, NA,
               2001, 13, 36, 57,
               2000,  8, 21, 33,
               1999,  6, 25, 47,
               1998, 6, 13, 22,
               1997, 6, 18, 29,
               1996, 4, 12, 28,
               1995, 3, 5, 20,
               1994, 2, 5, 34,
               1993, 2, 6, 15,
               1991, 2, 4, 19,
               1990, 1, 2, 15,
               1989, NA, NA, 11,
               1988, 1, NA, 13,
               1987, NA, NA, 10,
               1986, NA, NA, 5,
               1985, NA, NA, 1,
               1984, NA, NA, 2,
               1983, NA, NA, 5,
               1982, NA, NA, 2,
               1981, NA, NA, 1,
               1980, NA, NA, 5,
               1979, NA, NA, 2,
               1978, NA, NA, 1,
               1977, NA, NA, 2)

cit <- matrix(cit, nr=2010-1977, nc=4, byrow=TRUE)
cit <- as.data.frame(cit)
names(cit) <- c("Year","Title","Abstract","All")
par(mfrow=c(1,1))
par(cex=0.7, lwd=0.5)

plot(x=cit$Year, y=cit$Abstract, type="o",log="y",
     xlim=c(1975,2010),ylim=c(1,200),
     ylab="Number of publications (log)", xlab="Year", pch=2, 
     axes=FALSE)
axis(1, lwd=par("lwd"))
axis(2, lwd=par("lwd"), las=1)
# box(lwd=0.5)
lines(x=cit$Year, y=cit$Title, pch=15, type="o")
lines(x=cit$Year, y=cit$All, pch=16, type="o")
legend(x=1975,y=200,legend=c("early publications",
                            "'multiple imputation' in abstract",
                            "'multiple imputation' in title"),
       pch=c(16,2,15), bty="n")
```

### Section 2.2.4 MCAR, MAR and MNAR again

```{r}
logistic <- function(x) exp(x)/(1+exp(x))
set.seed(80122)
n <- 300
y <- mvrnorm(n=n,mu=c(0,0),Sigma=matrix(c(1,0.5,0.5,1),nrow=2))
y1 <- y[,1]
y2 <- y[,2]
r2.mcar <- 1-rbinom(n, 1, 0.5)
r2.mar  <- 1-rbinom(n, 1, logistic(y1))
r2.mnar <- 1-rbinom(n, 1, logistic(y2))

### Figure 2.2

y3 <- rbind(y,y,y)
r2 <- c(r2.mcar,r2.mar,r2.mnar)
r2 <- factor(r2, labels=c("Ymis","Yobs"))
typ <- factor(rep(3:1,each=n),labels=c("MNAR","MAR","MCAR"))
d <- data.frame(y1=y3[,1],y2=y3[,2],r2=r2,typ=typ)
trellis.par.set(box.rectangle=list(col=c(mdc(2),mdc(1)),lwd=1.2))
trellis.par.set(box.umbrella=list(col=c(mdc(2),mdc(1)),lwd=1.2))
trellis.par.set(plot.symbol=list(col=mdc(3),lwd=1))
tp <- bwplot(r2~y2|typ, data=d,
             horizontal=TRUE, layout=c(1,3),
             xlab=expression(Y^2),
             col=c(mdc(2),mdc(1)),strip=FALSE, xlim=c(-3,3),
             strip.left = strip.custom(bg="grey95"))
print(tp)
```

### Section 2.3.7 Numerical example

```{r}
imp <- mice(nhanes, print=FALSE, m=10, seed=24415)
fit <- with(imp, lm(bmi~age))
est <- pool(fit)
names(est)
attach(est)
(r+2/(df+3))/(r+1)
(df+1)/(df+3)*lambda+2/(df+3)
detach(est)
```

## Chapter 3 Univariate imputation

### Section 3.1 How to generate multiple imputations

```{r fig.height = 8}
library("mice")
library("lattice")
library("gamlss")
library("rpart")

### In order to draw figure 3.1, we define two tweaked
### mice.impute.xxx functions that will store the coefficients
### of the imputation models in the global environment.
### Normally, we would not be so interested in the
### parameter estimates of the imputation model, but here
### we need them for Figure 3.1.
mice.impute.normdump <- function (y, ry, x, ...) 
{
    x <- cbind(1, as.matrix(x))
    parm <- .norm.draw(y, ry, x, ...)
    betadump <<- c(betadump,parm$beta) 
    return(x[!ry, ] %*% parm$beta + rnorm(sum(!ry)) * parm$sigma)
}
mice.impute.pmmdump <- function (y, ry, x, ...) 
{
    x <- cbind(1, as.matrix(x))
    parm <- .norm.draw(y, ry, x, ...)
    yhatobs <- x[ry, ] %*% parm$coef
    yhatmis <- x[!ry, ] %*% parm$beta
    betadump <<- c(betadump,parm$beta)
    return(apply(as.array(yhatmis), 1, .pmm.match, yhat = yhatobs, 
        y = y[ry], ...))
}


### Figure 3.1
par(mfrow=c(3,2))
data <- whiteside
lwd <- 1.5
plot(x=data$Temp, y=data$Gas, col=mdc(1), lwd=lwd, 
     xlab=expression(paste("Temperature (", degree, "C)")), 
     ylab="Gas consumption (cubic feet)")
points(x=5, y=3.6, pch=4, cex=2, lwd=lwd, col=mdc(2))
legend(x="bottomleft", legend="deleted observation", pch=4, col=mdc(2), 
       pt.lwd=lwd, bty="n", pt.cex=2)
text(x=9, y=6.5, label="a",cex=2)

data[47,"Gas"] <- NA
plot(x=data$Temp, y=data$Gas, col=mdc(1), lwd=lwd, 
     xlab=expression(paste("Temperature (", degree, "C)")), 
     ylab="Gas consumption (cubic feet)")
abline(m1<-lm(Gas~Temp, data=data, na.action=na.omit), col=mdc(4))
points(5,4.04, lwd=lwd, col=mdc(2),pch=19)
text(x=9, y=6.5, label="b",cex=2)

plot(x=data$Temp, y=data$Gas, col=mdc(1), lwd=lwd, 
     xlab=expression(paste("Temperature (", degree, "C)")), 
     ylab="Gas consumption (cubic feet)")
imp <- mice(data, m=1, maxit=0)
pred <- imp$pred
pred["Gas","Insul"] <- 0
imp <- mice(data, m=5, pred=pred, meth="norm.nob", maxit=1, print=FALSE, seed=45433)
abline(m1<-lm(Gas~Temp, data=data, na.action=na.omit), col=mdc(4))
points(rep(5,5),imp$imp$Gas, lwd=lwd, col=mdc(2),pch=19)
text(x=9, y=6.5, label="c",cex=2)

plot(x=data$Temp, y=data$Gas, col=mdc(1), lwd=lwd, 
     xlab=expression(paste("Temperature (", degree, "C)")), 
     ylab="Gas consumption (cubic feet)")
imp <- mice(data, m=1, maxit=0)
pred <- imp$pred
pred["Gas","Insul"] <- 0
betadump <- vector("list", 0) 
imp <- mice(data, m=5, pred=pred, meth="normdump", maxit=1, print=FALSE, seed=83126)
abline(m1<-lm(Gas~Temp, data=data, na.action=na.omit), col=mdc(4))
betadump <- matrix(betadump, nc=2, byrow=TRUE)
for (i in 1:5) abline(coef=unlist(betadump[i,]), col=mdc(5))
points(rep(5,5),imp$imp$Gas, lwd=lwd, col=mdc(2),pch=19)
text(x=9, y=6.5, label="d",cex=2)

pch <- c(rep(3,26),rep(1,30))
plot(x=data$Temp, y=data$Gas, col=mdc(1), lwd=lwd, pch=pch, 
     xlab=expression(paste("Temperature (", degree, "C)")), 
     ylab="Gas consumption (cubic feet)")
imp <- mice(data, m=5, meth="norm", maxit=1, print=FALSE, seed=11727)
abline(m1<-lm(Gas~Temp, data=data, na.action=na.omit, subset=Insul=="Before"), col=mdc(4))
abline(m2<-lm(Gas~Temp, data=data, na.action=na.omit, subset=Insul=="After"), col=mdc(4))
points(rep(5,5),imp$imp$Gas, lwd=lwd, col=mdc(2),pch=19)
legend(x="bottomleft", legend=c("before insulation","after insulation"), pch=c(3,1),bty="n", pt.lwd=lwd)
text(x=9, y=6.5, label="e",cex=2)

pch <- c(rep(3,26),rep(1,30))
plot(x=data$Temp, y=data$Gas, col=mdc(1), lwd=lwd, pch=pch, 
     xlab=expression(paste("Temperature (", degree, "C)")), 
     ylab="Gas consumption (cubic feet)")
betadump <- vector("list", 0) 
imp <- mice(data, m=5, meth="pmmdump", maxit=1, print=FALSE, seed=68006)
betadump <- matrix(betadump, nc=3, byrow=TRUE)
m1<-lm(Gas~Temp+Insul, data=data, na.action=na.omit)
an <- coef(m1)[1]
ai <- an + coef(m1)[3]
b <- coef(m1)[2]
abline(a=ai, b=b, col=mdc(4))
abline(a=an, b=b, col=mdc(4))
eta <- 0.6
ylo <- ai+b*(5-eta)
yhi <- ai+b*(5+eta)
lines(x=c(5-eta,5+eta),y=c(ylo,yhi),lwd=3,col=mdc(5))
xlo <- (ylo-an)/b
xhi <- (yhi-an)/b
lines(x=c(xlo,xhi),y=c(ylo,yhi),lwd=3,col=mdc(5))

donors <- subset(data, (Insul=="After"&Temp>5-eta&Temp<5+eta) 
                 |    (Insul=="Before"&Temp>xlo&Temp<xhi))
points(x=donors$Temp, y=donors$Gas, cex=1.8, col=mdc(5), lwd=lwd)
legend(x="bottomleft", legend=c("before insulation","after insulation"), pch=c(3,1),bty="n", pt.lwd=lwd)
text(x=9, y=6.5, label="f",cex=2)
```

### Section 3.2.3 Performance

```{r}
### number of simulations
### use nsim <- 10 for testing
###     nsim <- 10000 for the real stuff (TIME CONSUMING)
nsim <- 10

### create data
createdata <- function(beta0=5.49, beta1=-0.29, sigma=0.86, n=50, mx=5, sdx=3) { 
  x <- round(rnorm(n,mean=mx,sd=sdx),1)
  eps <- rnorm(n,mean=0,sd=sigma)
  y <- round(beta0 + x * beta1 + eps, 1)
  return(data.frame(x=x, y=y))
}

### make 50% random missing data
makemissing <- function(data, p=0.5){
  rx <- rbinom(nrow(data), 1, p)
  data[rx==0,"y"] <- NA
  return(data)
}

### test function for three imputation functions
test.impute <- function(data, m=5, method="norm", ...){
  imp <- mice(data, method=method, m=m, print=FALSE, ridge=0, ...)
  fit <- with(imp, lm(y~x))
  est <- pool(fit)
  tab <- summary(est)
  return(tab["x",c("est","se","lo 95","hi 95","fmi","lambda")])
}

### put everything together
simulate <- function(nsim=10, seed=41872){
  set.seed(seed)
  res <- array(NA,dim=c(4, nsim, 6))
  dimnames(res) <- list(c("predict","pred + noise","Bayes MI","boot MI"),
                      as.character(1:nsim),
                      c("est","se","lo 95","hi 95","fmi","lambda"))
  im <- c("norm.predict","norm.nob","norm","norm.boot")
  for(i in 1:nsim){
    data <- createdata()
    data <- makemissing(data)
    res[1,i,] <- test.impute(data, method=im[1], m=2)
    res[2,i,] <- test.impute(data, method=im[2])
    res[3,i,] <- test.impute(data, method=im[3])
    res[4,i,] <- test.impute(data, method=im[4])
  }
  return(res)
}

summarize.results <- function(res) {
  apply(res,c(1,3),mean,na.rm=TRUE)

  ## bias of beta1
  true <- -0.29
  bias <- rowMeans(res[,,1] - true)

  ## coverage
  isin <- res[,,3] < true & true < res[,,4]
  cov <- rowMeans(isin)

  ## average width of 95 c.i.
  intwidth <- res[,,4] - res[,,3]
  aiw <- rowMeans(intwidth)

  return(list(bias=bias, cov=cov, aiw=aiw))
}

### do the simulations - MAY BE TIME CONSUMING
res <- simulate(nsim)
summarize.results(res)
```

```{r}
### function to simulate performance of CCA
simulate.cca <- function(nsim=10, seed=41872){

  set.seed(seed)
  res <- array(NA,dim=c(1, nsim, 6))
  for(i in 1:nsim){
    data <- createdata()
    data <- makemissing(data)
    fit <- lm(y~x, data=data, na.action=na.omit)
    est <- coef(summary(fit))
    lo95 <- est[,1] - qt(0.975,fit$df) * est[,2]
    hi95 <- est[,1] + qt(0.975,fit$df) * est[,2]
    est <- cbind(est, lo95, hi95)
    res[1,i,] <- c(est["x",c(1:2,5:6)],NA,NA)
  }
  return(res)
}

### simulate - MAY BE TIME CONSUMING
res.cca <- simulate.cca(nsim)
### cannot be analysed by summarize.results() but it should
### be obvious how to calculate bias, coverage and aiw
```

### Section 3.2.4 Generating MAR missing data

```{r}
### script to create missing data according to MARRIGHT
logistic <- function(x) exp(x)/(1+exp(x))
set.seed(32881)
n <- 10000
y <- mvrnorm(n=n,mu=c(5,5),Sigma=matrix(c(1,0.6,0.6,1),nrow=2))
p2.marright <- 1 - logistic(-5 + y[,1])
r2.marright <- rbinom(n, 1, p2.marright)
yobs <- y
yobs[r2.marright==0, 2] <- NA

### Figure 3.2

grid <- seq(0,10,0.1)
mr <- logistic(-5 + grid)
mm <- logistic( 0.75-abs(grid-5))
mt <- logistic(-0.75+abs(grid-5))

par(mfrow=c(1,1))
z <- data.frame(grid, mr, mm, mt) 
matplot(x=z[,1],y=z[,2:4], type="l", lty=1:3, col=mdc(5) , lwd=2,
        xlab="Y1", ylab="Missingness in Y2", las=1)
legend(x="top", bty="n",
       legend=c("MARRIGHT","MARMID","MARTAIL"), lty=1:3, lwd=2, col=mdc(5), cex=0.8)
```

```{r}
### Figure 3.3

y3 <- rbind(y,y,y)
p2.marmid <- 1 - logistic(0.75-abs(y[,1]-5))
p2.martail <- 1 - logistic(0.75+abs(y[,1]-5))
r2.marmid <- rbinom(n, 1, p2.marright)
r2.martail <- rbinom(n, 1, p2.martail)
r2 <- c(r2.marright,r2.marmid,r2.martail)
r2 <- factor(r2, labels=c("Ymis","Yobs"))
typ <- factor(rep(3:1,each=n),labels=c("MARTAIL","MARMID","MARRIGHT"))
d <- data.frame(y1=y3[,1],y2=y3[,2],r2=r2,typ=typ)
trellis.par.set(box.rectangle=list(col=c(mdc(2),mdc(1)),lwd=1.2))
trellis.par.set(box.umbrella=list(col=c(mdc(2),mdc(1)),lwd=1.2))
trellis.par.set(plot.symbol=list(col="transparent",lwd=1))
tp <- bwplot(r2~y2|typ, data=d,
             horizontal=TRUE, layout=c(1,3),
             xlab=expression(Y2),
             col=c(mdc(2),mdc(1)),strip=FALSE, xlim=c(2,8),
             strip.left = strip.custom(bg="grey95"))
print(tp)
```

### Section 3.2.2 Imputation from the t-distribution

```{r}
mice.impute.tf <- function(y, ry, x, 
                  gamlss.trace = FALSE, ...)
{
  require(gamlss)

  # prepare data
  xobs <- x[ry, , drop = FALSE]
  xmis <- x[!ry, , drop = FALSE]
  yobs <- y[ry]
  n1 <- sum(ry)
  n0 <- sum(!ry)

  # draw bootstrap sample
  s <- sample(n1, n1, replace = TRUE)
  dotxobs <- xobs[s, , drop = FALSE]
  dotyobs <- yobs[s]
  dotxy <- data.frame(dotxobs, y = dotyobs)
  
  # fit the gamlss model
  fit <- gamlss(y ~ ., data = dotxy, family = TF, 
                trace = gamlss.trace, ...)
  yhat <- predict(fit, data=dotxy, newdata = xmis)
  sigma <- exp(coef(fit, "sigma"))
  nu <- exp(coef(fit, "nu"))
  
  # draw the imputations
  return(rTF(n0, yhat, sigma, nu))
}
```

### Section 3.3.3 Example

```{r}
data(db)

### Figure 3.4

par(mfrow=c(1,2))
data <- subset(db, age>1&age<2, c("age","head"))
names(data) <- c("age","hc")
truehist(data$hc, col=mdc(1), border="white", 
         xlab="Head circumference (cm)",
         ylab="Density",
         ylim=c(0,0.3), xlim=c(38,60),
         nbins=44)

mn <- gamlss(hc~1, data=na.omit(data), family=NO, trace=FALSE)
mu <- coef(mn)
sigma <- exp(coef(mn, "sigma"))
cmfine <- seq(38,60,0.1)
lines(cmfine, dNO(cmfine, mu, sigma), lwd=0.8, lty=2) 
mt <- gamlss(hc~1, data=data, family=TF, trace=FALSE)
mu <- coef(mt)
sigma <- exp(coef(mt, "sigma"))
nu <- exp(coef(mt, "nu"))
lines(cmfine, dTF(cmfine, mu, sigma, nu), lwd=0.8, lty=1) 
legend(x="right",legend=c("normal","t, df=6.7"), 
       lwd=0.8, lty=c(2,1), bty="n", cex=0.7)

plot(x=data$age, y=data$hc, col=mdc(1), cex=0.3,
     xlab="Age (in years)",
     ylab="Head circumference (cm)",
     ylim=c(39,60))
```

```{r}
### create a synthetic data set
data(db)
data <- subset(db, age>1&age<2, c("age","head"))
names(data) <- c("age","hc")
synthetic <- rep(c(FALSE,TRUE), each=nrow(data))
data2 <- rbind(data, data)
data2[synthetic,"hc"] <- NA
imp <- mice(data2, m=1, meth="tf", seed=36650, print=FALSE)
syn <- subset(complete(imp), synthetic)

### Figure 3.5

data <- syn
truehist(data$hc, col=mdc(2), border="white", 
         xlab="Head circumference (cm)",
         ylab="Density",
         ylim=c(0,0.3), xlim=c(38,60),
         nbins=44)

mn <- gamlss(hc~1, data=na.omit(data), family=NO, trace=FALSE)
mu <- coef(mn)
sigma <- exp(coef(mn, "sigma"))
cmfine <- seq(38,60,0.1)
lines(cmfine, dNO(cmfine, mu, sigma), lwd=0.8, lty=2) 
mt <- gamlss(hc~1, data=data, family=TF, trace=FALSE)
mu <- coef(mt)
sigma <- exp(coef(mt, "sigma"))
nu <- exp(coef(mt, "nu"))
lines(cmfine, dTF(cmfine, mu, sigma, nu), lwd=0.8, lty=1) 
legend(x="right",legend=c("normal",paste("t, df=",round(nu,1),sep="")), 
       lwd=0.8, lty=c(2,1), bty="n", cex=0.7)
plot(x=data$age, y=data$hc, col=mdc(2), cex=0.3,
     xlab="Age (in years)",
     ylab="Head circumference (cm)",
     ylim=c(39,60))
```

### Section 3.4.1 PMM, Overview

```{r}
### Figure 3.6

data <- boys[boys$age<=2,c("age","bmi")]
set.seed(87120)
data[sample(92:136,10),"bmi"] <- NA
imp <- mice(data, meth="norm", m=1, seed=32212, print=FALSE)
cd1 <- complete(imp)
imp <- mice(data, m=1, seed=32212, print=FALSE)
cd2 <- complete(imp)
r <- !is.na(data$bmi)
plot(data, col=mdc(1), xlab="Age", ylab="BMI")
points(cd1[!r,], col=mdc(2), pch=19, cex=0.8)
plot(data, col=mdc(1), xlab="Age", ylab="BMI")
points(cd2[!r,], col=mdc(2), pch=19, cex=0.8)
```

### Section 3.4.2 PMM, Computational details

```{r}
### Figure 3.7

par(mfrow=c(1,1))
data <- whiteside
lwd <- 1.5
data[47,"Gas"] <- NA

pch <- c(rep(3,26),rep(1,30))
plot(x=data$Temp, y=data$Gas, col=mdc(1), lwd=lwd, pch=pch, 
     xlab=expression(paste("Temperature (", degree, "C)")), 
     ylab="Gas consumption (cubic feet)")
betadump <- vector("list", 0) 
imp <- mice(data, m=5, meth="pmmdump", maxit=1, print=FALSE, seed=68006)
betadump <- matrix(unlist(betadump), nc=3, byrow=TRUE)
m1<-lm(Gas~Temp+Insul, data=data, na.action=na.omit)
an <- coef(m1)[1]
ai <- an + coef(m1)[3]
b <- coef(m1)[2]
abline(a=ai, b=b, col=mdc(4))
abline(a=an, b=b, col=mdc(4))
## for (i in 56:56) {
##    abline(a=unlist(betadump[i,1]), b=unlist(betadump[i,2]), col=mdc(5))
##    abline(a=unlist(betadump[i,1])+unlist(betadump[i,3]), b=unlist(betadump[i,2]), col=mdc(5))
## }
## points(rep(5,5),imp$imp$Gas, lwd=lwd, col=mdc(2), pch=20) 
eta <- 0.6
ylo <- ai+b*(5-eta)
yhi <- ai+b*(5+eta)
lines(x=c(5-eta,5+eta),y=c(ylo,yhi),lwd=3,col=mdc(4))
an <- 7.05; ai<-an-1.7; b <- -0.38
xlo1 <- (ylo-ai)/b
xhi1 <- (yhi-ai)/b
xlo2 <- (ylo-an)/b
xhi2 <- (yhi-an)/b
abline(a=an, b=b, col=mdc(5))
abline(a=ai, b=b, col=mdc(5))
lines(x=c(xlo1,xhi1),y=c(ylo,yhi),lwd=3,col=mdc(5))
lines(x=c(xlo2,xhi2),y=c(ylo,yhi),lwd=3,col=mdc(5))
abline(v=c(5-eta,5+eta),h=c(ylo,yhi),col=mdc(4),lty=3)
rect(xlo1,0,xhi1,8,col=hcl(0,100,40,0.05),border=NA)
rect(xlo2,0,xhi2,8,col=hcl(0,100,40,0.05),border=NA)
# abline(v=c(xlo1,xhi1,xlo2,xhi2),col=mdc(5),lty=3)

donors <- subset(data, (Insul=="After"&Temp>xlo1&Temp<xhi1) 
                 |    (Insul=="Before"&Temp>xlo2&Temp<xhi2))
points(x=donors$Temp, y=donors$Gas, cex=1.8, col=mdc(5), lwd=lwd)
legend(x="bottomleft", legend=c("before insulation","after insulation"), pch=c(3,1),bty="n", pt.lwd=lwd)
```

### Section 3.4.3 PMM, Algorithm 
```{r}
### simulate function used to calculate Table 3.3
simulate <- function(nsim=10, seed=41872){
  set.seed(seed)
  res <- array(NA,dim=c(3, nsim, 6))
  for(i in 1:nsim){
    data <- createdata()
    data <- makemissing(data)
    res[1,i,] <- test.impute(data, m=5)
    res[2,i,] <- test.impute(data, m=5, donors=1)
    res[3,i,] <- test.impute(data, m=5, donors=10)
  }
  return(res)
}

### and perform simulations - MAY BE TIME CONSUMING
res.pmm <- simulate(nsim)
summarize.results(res.pmm)
```

### Section 3.7.1

```{r}
### Figure 3.8

par(mfrow=c(1,2))
fit <- rpart(Gas ~ Temp + Insul, data=whiteside)
plot(fit, branch=0, margin=0.15)
text(fit, use=T,pretty=0,dig=3,cex=0.8)

leaf <- row.names(fit$frame)[fit$where]
label <- factor(leaf, labels=c(2,3,1,4,5))
plot(x=whiteside$Temp, y=whiteside$Gas, type="n",
     xlab=expression(paste("Temperature (", degree, "C)")), 
     ylab="Gas consumption (cubic feet)")
text(x=whiteside$Temp, y=whiteside$Gas, label=label, col=mdc(4), cex=0.6)
```


### Section 3.9.4 Converting selection and pattern-mixture models

```{r}
### Figure 3.9

par(mfrow=c(1,2))
s <- c(
       100, 0.015, 0.058, 0.02, 0.35,
       110, 0.024, 0.074, 0.03, 0.30,
       120, 0.043, 0.103, 0.05, 0.25,
       130, 0.091, 0.164, 0.10, 0.20,
       140, 0.145, 0.185, 0.15, 0.15,
       150, 0.307, 0.247, 0.30, 0.10,
       160, 0.157, 0.099, 0.15, 0.08,
       170, 0.107, 0.049, 0.10, 0.06,
       180, 0.055, 0.016, 0.05, 0.04,
       190, 0.033, 0.005, 0.03, 0.02,
       200, 0.023, 0.000, 0.02, 0.00,
       210, 0.023, 0.000, 0.02, 0.00
       )
sm <- matrix(s, nr=12, nc=5, byrow=TRUE)
snug <- 1.5
xx <- cbind(sm[,1]-5+snug,
        sm[,1]-5-snug,
        sm[,1]-5)
matplot(x=xx[,3], y=cbind(1-sm[,5]),
        col=mdc(1), type="p", lwd=2, lty=1, pch=20,
        xlab="Systolic BP (mmHg)",
        ylab="Observation probability")
matplot(x=xx, y=sm[,2:4], type="s",
        col=c(mdc(4),mdc(5),mdc(6)), lwd=2, lty=1,
        xlab="Systolic BP (mmHg)",
        ylab="Density")
```


## Chapter 4 Multivariate missing data

### Section 4.1 Missing data patterns

```{r}
library("mice")
library("lattice")

### define data sets pattern1-pattern4 with four patterns
data <- matrix(sample(1:100,4*8*3,replace=TRUE),nrow=8*4,
                dimnames=list(NULL,c("A","B","C")))
data <- as.data.frame(data)
data[c(31:32),"A"] <- NA
data[c(15:16,22:24,30:32),"B"] <- NA
data[c(6:8,12:16,17:21,27:29),"C"] <- NA
mdpat <- cbind(expand.grid(rec = 8:1, pat = 1:4, var = 1:3), r=as.numeric(as.vector(is.na(data))))
pattern1 <- data[1:8,]
pattern2 <- data[9:16,]
pattern3 <- data[17:24,]
pattern4 <- data[25:32,]

### Figure 4.1
types <-  c("Univariate","Monotone","File matching","General")
tp41 <- levelplot(r~var+rec|as.factor(pat), data=mdpat,
          as.table=TRUE, aspect="iso",
          shrink=c(0.9), 
          col.regions = mdc(1:2),
          colorkey=FALSE,
          scales=list(draw=FALSE),
          xlab="", ylab="",
          between = list(x=1,y=0),
          strip = strip.custom(bg = "grey95", style = 1,
            factor.levels = types))
print(tp41)
```

```{r fig.height=6}
md.pattern(pattern4)
p <- md.pairs(pattern4)
p


### proportion of usable cases
p$mr/(p$mr+p$mm)


### outbound statistics
p$rm/(p$rm+p$rr)

### Figure 4.2
par(mfrow=c(2,2))
fluxplot(pattern1, main="", xlim=c(-0.1,1.1), ylim=c(-0.1,1.1))
text(x=0.5,y=1,label="Univariate")
fluxplot(pattern2, main="", xlim=c(-0.1,1.1), ylim=c(-0.1,1.1))
text(x=0.5,y=1,label="Monotone")
fluxplot(pattern3, main="", xlim=c(-0.1,1.1), ylim=c(-0.1,1.1))
text(x=0.5,y=1,label="File matching")
fluxplot(pattern4, main="", xlim=c(-0.1,1.1), ylim=c(-0.1,1.1))
text(x=0.5,y=1,label="General")
```

```{r}
### calculate pobs, influx, outflux of general pattern
flux(pattern4)[,1:3]

### section 4.3 Monotone data imputation
### monotone data imputation on three columns
data <- nhanes2[,1:3]
md.pattern(data)
imp <- mice(data, visit="monotone", maxit=1, m=2)

### Numerical example, approximate two-step
ini <- mice(nhanes2, maxit=0)
pred <- ini$pred
pred["bmi","chl"] <- 0
pred["hyp",c("chl","bmi")] <- 0
imp <- mice(nhanes2, vis="monotone", pred=pred, maxit=1, m=2)
```

### Section 4.5 Fully Conditional Specification

```{r cache=TRUE}
### Example of slow convergence
generate <- function(n = c(1000, 4500, 4500, 0),
                     cor = matrix(c(1, 0.9, 0.9, 0.9, 1, 0.7, 0.9, 0.7, 1), nrow = 3)) {
  require(MASS)
  nt <- sum(n)
  cs <- cumsum(n)
  data <- mvrnorm(nt, mu = rep(0,3), Sigma = cor)
  dimnames(data) <- list(1:nt, c("X", "Y1", "Y2"))
  if (n[2] > 0) data[(cs[1]+1):cs[2],"Y1"] <- NA 
  if (n[3] > 0) data[(cs[2]+1):cs[3],"Y2"] <- NA
  if (n[4] > 0) data[(cs[3]+1):cs[4],c("Y1","Y2")] <- NA
  return(data)
}

impute <- function(data, m = 5, method="norm", print=FALSE, maxit = 10, ...) {
  statistic <- matrix(NA, nrow=maxit, ncol=m)
  for (iter in 1:maxit) {
    if (iter==1) imp <- mice(data, m = m, method = method, print=print, maxit = 1, ...)
    else imp <- mice.mids(imp, maxit=1, print=print, ...)
    statistic[iter,] <- unlist(with(imp, cor(Y1,Y2))$analyses)
  }
  return(list(imp=imp, statistic=statistic))
}

simulate <- function(ns=matrix(c(1000,500,250,100,50,0,
                               rep(c(4500,4750,4875,4950,4975,5000),2),
                       rep(0,6)), nrow=6), m = 5, maxit=10,
                       seed=1, ...) {
  if (!missing(seed)) set.seed(seed)
  s <- cbind(rep(1:nrow(ns), each=maxit*m),
             apply(ns, 2, rep, each=maxit*m),
             rep(1:maxit,each=m), 1:m, NA)
  colnames(s) <- c("k","n111","n101","n110","n100","iteration","m","rY1Y2")
  for (k in 1:nrow(ns)){
    data <- generate(ns[k,], ...)
    r <- impute(data, m=m, maxit=maxit, ...)
    s[s[,"k"]==k,"rY1Y2"] <- t(r$statistic) 
  }
  return(data.frame(s))
}

### perform simulation - TIME CONSUMING (10 minutes)
slow.demo <- simulate(maxit=150, seed=62771)
```

```{r cache=TRUE}
### Figure 4.3
labels <- c("90% missing", "95% missing", "97.5% missing", 
            "99% missing", "99.5% missing", "100% missing")
tp43 <- xyplot(rY1Y2~iteration|as.factor(k), group=m,
       data = slow.demo, layout=c(3,2),
       type="l", as.table = TRUE,
       ylab = "Correlation between Y1 and Y2",
       xlab = "Iteration", col=mdc(3),
       scales=list(y=list(alternating=1, tck=c(1,0))),
       strip = strip.custom(bg="grey95", style=1,
         factor.levels=labels))
print(tp43)
```

### Section 4.6.3 Illustration

```{r cache=TRUE}
## boys data: select subset
select <- with(boys, age>=8 & age<=21.0)

### version with all numeric data for jm and pmm
djm <- boys[select,-4]
djm$gen <- as.integer(djm$gen)
djm$phb <- as.integer(djm$phb)
djm$reg <- as.integer(djm$reg)

### version with categorical variables for fcs
dfcs <- boys[select,-4]

### impute according to joint multivariate normal
jm.10 <- mice(djm, method="norm", seed=93005, m=10, print=FALSE)

### impute according to predictive mean matching
pmm.10 <- mice(djm, seed=71332,m=10, print=FALSE)

### impute according to proportional odds model
fcs.10 <- mice(dfcs, seed=81420, m=10, print=FALSE)

### Figure 4.4
tp44 <- xyplot(jm.10, gen~age|.imp, subset=as.integer(.imp)<7, 
       xlab="Age", ylab="Genital stage")
print(tp44)
```

```{r}
### Figure 4.5
tp45 <- xyplot(fcs.10, gen~age|.imp, subset=as.integer(.imp)<7,
       xlab="Age", ylab="Genital stage")
print(tp45)
```

```{r}
### Figure 4.6 is too complex, and will not be given here
```


## Chapter 5

```{r}
library("mice")
library("gamlss")
library("AGD")

### set Trellis layout parameters
lhset <- trellis.par.get("layout.heights")
lhset$top.padding <- 0
lhset$bottom.padding <- 0
trellis.par.set("layout.heights", lhset)
lwset <- trellis.par.get("layout.widths")
lwset$left.padding <- 0
lwset$right.padding <- 0
trellis.par.set("layout.widths", lwset)
```

### Section 5.3.2 Predictors

```{r}
imp <- mice(nhanes, print=FALSE)
imp$predictorMatrix
imp <- mice(cbind(nhanes, chl2=2*nhanes$chl), print=FALSE)
imp$loggedEvents
```

### Section 5.4.1 Ratio of two variables

```{r}
imp1 <- mice(boys)
long <- complete(imp1, "long", inc=TRUE)
long$whr <- with(long, wgt/(hgt/100))
# imp2 <- long2mids(long)

### Just anothor varianble (JAV)
boys$whr <- boys$wgt/(boys$hgt/100)
imp.jav <- mice(boys, m=1, seed=32093, maxit=10)
imp.jav$loggedEvents

### Passive imputation
ini <- mice(boys, m=1, maxit=0)
meth <- ini$meth
meth["whr"] <- "~I(wgt/(hgt/100))"
meth["bmi"] <- "~I(wgt/(hgt/100)^2)"
pred <- ini$pred
pred[c("wgt","hgt","bmi"),"whr"] <- 0
pred[c("wgt","hgt","whr"),"bmi"] <- 0
pred
imp.pas <- mice(boys, m=1, meth=meth, pred=pred, seed=32093, maxit=10)

### passive imputation 2 
pred[c("wgt","hgt","hc","reg"),"bmi"] <- 0
pred[c("gen","phb","tv"),c("hgt","wgt","hc")] <- 0
pred[,"whr"] <- 0
imp.pas2 <- mice(boys, m=1, meth=meth, pred=pred, seed=32093, maxit=10)

### Figure 5.1
c1 <- cbind(model="JAV",complete(imp.jav))
c2 <- cbind(model="passive",complete(imp.pas))
c3 <- cbind(model="passive 2",complete(imp.pas2))
cd <- rbind(c1,c2, c3)
trellis.par.set(mice.theme())
tp51 <- xyplot(whr~hgt|model,data=cd,layout=c(3,1),
       groups=rep(is.na(imp.jav$data$whr),3), pch=c(1,20), cex=c(0.4,1),
       xlab="Height (cm)", ylab="Weight/Height (kg/m)")
print(tp51)
```

### Section 5.4.3 Interaction terms

```{r}
rm(boys)
expr <- expression((wgt-40)*(hc-50))
boys$wgt.hc <- with(boys, eval(expr))
ini <- mice(boys, max=0)
meth <- ini$meth
meth["wgt.hc"] <- paste("~I(",expr,")",sep="")
meth["bmi"] <- ""
pred <- ini$pred
pred[c("wgt","hc"),"wgt.hc"] <- 0
imp.int <- mice(boys, m=1, maxit=10, meth=meth, pred=pred, seed=62587)

### Figure 5.2
miss <- is.na(imp.int$data$wgt.hc)
tp52a <- xyplot(imp.int, wgt~wgt.hc, na.groups = miss,
       cex=c(0.8,1.2), pch=c(1,20),
       ylab="Weight (kg)", xlab="Interaction")
tp52b <- xyplot(imp.int, hc~wgt.hc, na.groups = miss,
       cex=c(0.8,1.2), pch=c(1,20),
       ylab="Head circumference (cm)", xlab="Interaction")
print(tp52a)
print(tp52b)
```

### Section 5.4.4 Conditional imputation

```{r}
ini <- mice(airquality[,1:2],maxit=0)
post <- ini$post
post["Ozone"] <- "imp[[j]][,i] <- squeeze(imp[[j]][,i],c(1,200))"
### Note: ifdo() not yet implemented
### so for the moment use old form
## post["Ozone"] <- "ifdo(c(Ozone<1, Ozone>200), c(1, 200))"
imp <- mice(airquality[,1:2],method="norm.nob",m=1,maxit=1,seed=1,post=post)

### Figure 5.3

lwd <- 1.5
par(mfrow=c(1,2))
breaks <- seq(-20, 200, 10)
nudge <- 1
x <- matrix(c(breaks-nudge, breaks+nudge), ncol=2)
obs <- airquality[,"Ozone"]
mis  <- imp$imp$Ozone[,1]
fobs <- c(hist(obs, breaks, plot=FALSE)$counts, 0)
fmis <- c(hist(mis, breaks, plot=FALSE)$counts, 0)
y <- matrix(c(fobs, fmis), ncol=2)
matplot(x, y, type="s",
        col=c(mdc(4),mdc(5)), lwd=2, lty=1,
        xlim = c(0, 170), ylim = c(0,40), yaxs = "i",
        xlab="Ozone (ppb)",
        ylab="Frequency")
box()

tp <- xyplot(imp, Ozone~Solar.R, na.groups=ici(imp),
       ylab="Ozone (ppb)", xlab="Solar Radiation (lang)",
       cex = 0.75, lex=lwd,
       ylim = c(-20, 180), xlim = c(0,350))
print(tp, newpage = FALSE, position = c(0.48,0.08,1,0.92))
```

### Post-processing on the boys data

```{r}
post <- mice(boys, m=1, maxit=0)$post
post["gen"] <- "imp[[j]][p$data$age[!r[,j]]<8,i] <- levels(boys$gen)[1]"
post["phb"] <- "imp[[j]][p$data$age[!r[,j]]<8,i] <- levels(boys$phb)[1]"
post["tv"]  <- "imp[[j]][p$data$age[!r[,j]]<8,i] <- 1"
free <- mice(boys, m=1, seed=85444, print=FALSE)
restricted <- mice(boys, m=1, post=post, seed=85444, print=FALSE)

### The following code using ifdo does not yet work
### Use the form given above
## post <- mice(boys, m=1, maxit=0)$post
## post["gen"] <- "ifdo(age<8, levels(gen)[1])"
## post["phb"] <- "ifdo(age<8, levels(phb)[1])"
## post["tv"] <- "ifdo(age<8, 1)"
## free <- mice(boys, m=1, seed=85444)
## restricted <- mice(boys, m=1, post=post, seed=85444)


### Figure 5.4

imp3 <- rbind(free, restricted)  # ignore warning
model <- rep(c("Free","Restricted"),each=nrow(boys))
tp54 <- xyplot(imp3, gen~age|model, pch=c(3,1), cex=c(3,1.5),
            ylab="Genital development", xlab="Age (years)")
print(tp54)
```

### Section 5.4.5 Compositional data

```{r}
set.seed(43112)
n <- 400
Y1 <- sample(1:10, size=n, replace=TRUE)
Y2 <- sample(1:20, size=n, replace=TRUE)
Y3 <- 10 + 2 * Y1 + 0.6 * Y2 + sample(-10:10, size=n, replace=TRUE)
Y <- data.frame(Y1, Y2, Y3)
Y[1:100, 1:2] <- NA
md.pattern(Y)

Y123 <- Y1+Y2+Y3
Y12 <- Y123-Y[,3]
P1 <- Y[,1]/Y12
data <- data.frame(Y, Y123, Y12, P1)

ini <- mice(data, maxit=0, m=10, print=FALSE, seed=21772)
meth <- ini$meth
meth["Y1"] <- "~I(P1*Y12)"
meth["Y2"] <- "~I((1-P1)*Y12)"
meth["Y12"] <- "~I(Y123-Y3)"
pred <- ini$pred
pred["P1",] <- 0
pred[c("P1"),c("Y12","Y3")] <- 1
imp1 <- mice(data, meth=meth, pred=pred, m=10, print=FALSE)

round(summary(pool(with(imp1, lm(Y3~Y1+Y2))))[,1:2],2)

### improved solution for Figure 5.5b
ini <- mice(data, maxit=0, m=10, print=FALSE, seed=21772)
meth <- ini$meth
meth["Y1"] <- "~I(P1*Y12)"
meth["Y2"] <- "~I((1-P1)*Y12)"
meth["Y12"] <- "~I(Y123-Y3)"
pred <- ini$pred
pred["P1",] <- 0
pred[c("P1"),c("Y12","Y3")] <- 1
imp1 <- mice(data, meth=meth, pred=pred, m=1, print=FALSE)
pred["P1","Y3"] <- 0
imp2 <- mice(data, meth=meth, pred=pred, m=1, print=FALSE)

### Figure 5.5
imp <- rbind(imp1, imp2)  # ignore warning
model <- rep(c("Y12 and Y3","Y12 only"),each=n)
tp55 <- xyplot(imp, P1~Y12|model, pch=c(1,19), xlab="Y1 + Y2")
print(tp55)
```

### Section 5.5.1 Visit sequence

```{r}
### Continue from the imp.int object calculated in section 5.4.3 
imp.int$vis
vis <- c(2,3,5,10,6:9)
rm(boys)  # refresh boys data
expr <- expression((wgt-40)*(hc-50))
boys$wgt.hc <- with(boys, eval(expr))
imp.int2 <- mice(boys, m=1, max=1, vis=vis, meth=imp.int$meth, pred=imp.int$pred, seed=23390)

### monotone sequence
imp.int2 <- mice(boys, m=1, max=1, vis="monotone", meth=imp.int$meth, pred=imp.int$pred, seed=23390)

### Section 5.5.2 Convergence

### Figure 5.6 Default color version

imp <- mice(nhanes, seed=62006, maxit=20, print=FALSE)
tp56 <- plot(imp)
print(tp56)

### Figure 5.6 Book version

# tp56b <- plot(imp, col=mdc(5), lty=1:5)
# print(tp56b)
```

### Example of pathological convergence

```{r}
rm(boys)
ini <- mice(boys,max=0,print=FALSE)
meth <- ini$meth
meth["bmi"] <- "~I(wgt/(hgt/100)^2)"
imp.bmi1 <- mice(boys, meth=meth, maxit=20, seed=60109)

### Figure 5.7
### Does not reproduce exactly, but the message is the same
tp57 <- plot(imp.bmi1,c("hgt","wgt","bmi"), col=mdc(5), lty=1:5)
print(tp57)
```

```{r}
### Breaking cyclic imputations for hgt and wgt
pred <- ini$pred
pred[c("hgt","wgt"),"bmi"] <- 0
imp.bmi2 <- mice(boys, meth=meth, pred=pred, maxit=20, seed=60109)

### Figure 5.8
### Does not reproduce exactly, but the message is the same
tp58 <- plot(imp.bmi2,c("hgt","wgt","bmi"), col=mdc(5), lty=1:5)
print(tp58)
```

### Section 5.6.2 Diagnostic graphs

```{r}
set.seed(24417)
### create 50% missing data in wgt
boys$wgt[sample(1:nrow(boys),nrow(boys)/2)] <- NA
meth <- c("","pmm","pmm","","pmm","polr","polr","pmm","polyreg")
imp <- mice(boys, m=1, meth=meth, seed=53882, print=FALSE)

### Simple scatterplot wgt-age (not given in book)
tp58b <- xyplot(imp, wgt~age|.imp)
print(tp58b)
```

```{r}
### Fit separate regression models for wgt
### for observed (n=372) and imputed (n=376) data
cd <- complete(imp)[,-4]
isobs <- !is.na(boys$wgt)
cdobs <- cd[isobs,]
cdmis <- cd[!isobs,]
obs <- gamlss(wgt~age+hgt+hc+gen+phb+tv+reg, data=na.omit(cdobs))
mis <- gamlss(wgt~age+hgt+hc+gen+phb+tv+reg, data=na.omit(cdmis))

### Figure 5.9 worm plot
wp.twin(obs, mis, xvar=NULL, xvar.column=2, n.inter=9, col1=mdc(4), col2=mdc(5), ylim=0.9, cex=1, pch=1)
```

### Figure 5.10

```{r}
imp <- mice(nhanes, seed=29981)
tp510 <- stripplot(imp, pch=c(1,20))
print(tp510)
```

### Figure 5.11

```{r}
tp511 <- densityplot(imp)
print(tp511)
```

### Calculate propensity scores

```{r}
fit <- with(imp, glm(ici(imp)~age+bmi+hyp+chl,family=binomial))
ps <- rep(rowMeans(sapply(fit$analyses, fitted.values)),imp$m)

### Figure 5.12
tp512 <- xyplot(imp, bmi~ps|.imp, pch=c(1,19), 
       xlab="Probability that record is incomplete", 
       ylab="BMI")
print(tp512)
```


## Chapter 6


### Section 6.1.1 Averaging and stacking the data

```{r}
library("mice")
imp <- mice(nhanes, print=FALSE, seed=55152)
stacked <- complete(imp, "long")
fit <- lm(chl~bmi+age,data=stacked)
coef(fit)
```

### Section 6.1.2 Repeated analyses

```{r}
fit <- with(imp, lm(chl~bmi+age))
coef(fit$analyses[[1]])
coef(fit$analyses[[2]])

est <- pool(fit)
summary(est)

expr <- expression(freq <- table(hyp), freq[1]-freq[2])
fit <- with(imp, eval(expr))
unlist(fit$an)
```

### Section 6.3.5 Computation

```{r}
imp <- mice(nhanes2, seed=23210, print=FALSE)
fit <- with(imp, lm(bmi~age+chl))
fit.restrict <- with(imp, lm(bmi~1))
res <- pool.compare(fit, fit.restrict)
res$pvalue

est <- pool(fit)
summary(est)

C <- matrix(c(c(0,1,-1,0),c(0,2,-1,0),c(0,0,0,1)),nrow=3,ncol=4,byrow=TRUE)
c <- c(0,0,0.1)
q <- C %*% est$qbar
u <- diag(C %*% est$ubar %*% t(C))
t <- diag(C %*% est$t %*% t(C))
C1 <- C
C1[C1!=0] <- 1
df <- C1 %*% est$df    # this needs to change to compromise df
d <- (q-c)^2/t
pvalue <- 1-pf(d, 1, df)
pvalue
```

### Section 6.4.2 Computation

```{r results="hide"}
data <- boys[boys$age>=8,-4]
imp <- mice(data, seed=28382, m=10, print=FALSE)
expr <- expression(
    f1 <- lm(tv~1),
    f2 <- step(f1, scope=list(upper=~age+hgt+wgt+hc+gen+phb+reg), lower=~1)) 
```

```{r}
fit <- with(imp, expr)
formulas <- lapply(fit$an, formula)
terms <- lapply(formulas, terms)
vars <- unlist(lapply(terms, labels))
table(vars)

fit.without <- with(imp, lm(tv~age+gen+reg+phb))
fit.with <- with(imp, lm(tv~age+gen+reg+phb+hgt))
pool.compare(fit.with, fit.without)$pvalue

fit.without <- with(imp, lm(tv~age+gen+reg))
fit.with <- with(imp, lm(tv~age+gen+reg+phb))
pool.compare(fit.with, fit.without)$pvalue
```


## Chapter 7

### Section 7.1 Too many columns

```{r}
library("mice")
library("lattice")
library("foreign")
library("survival")
```

### Section 7.1.3 Data exploration

```{r eval=FALSE}
data <- leiden85  ## Note: the leiden85 data is not yet avialable in V2.12
if (!is.data.frame(data)) warning("The code for section 7.1/7.2 requires access to the LEIDEN85 data.")

ini <- mice(data, maxit = 0)  # recommended 
table(ini$nmis)

table(data$beroep1, useNA = "always")

v1 <- names(ini$nmis[ini$nmis == 0])
outlist1 <- v1[c(1, 3:5, 7:10, 16:47, 51:60, 62, 64:65, 
  69:72)]
length(outlist1)
```

### Section 7.1.4 Outflux

```{r eval=FALSE}
fx <- fluxplot(data, main = NULL, cex = 0.9)

outlist2 <- row.names(fx)[fx$outflux < 0.5]
length(outlist2)

data2 <- data[, !names(data) %in% outlist2]
fx2 <- flux(data2)
outlist3 <- row.names(fx2)[fx2$outflux < 0.5]
```

### Section 7.1.5 Logged events

```{r eval=FALSE}
ini$log[1:3, ]

outlist4 <- as.character(ini$log[, "out"])
```

### Section 7.1.6 Quick predictor selection for wide data

```{r eval=FALSE}
outlist <- unique(c(outlist1, outlist2, outlist4))
length(outlist)

data2 <- data[, !names(data) %in% outlist]

inlist <- c("sex", "lftanam", "rrsyst", "rrdiast")
pred <- quickpred(data2, minpuc = 0.5, inc = inlist)

table(rowSums(pred))

rowSums(pred[c("rrsyst", "rrdiast"), ])

names(data2)[pred["rrsyst", ] == 1]

vname <- "rrsyst"
y <- cbind(data2[vname], r = !is.na(data2[, vname]))
vdata <- data2[, pred[vname, ] == 1]
round(cor(y = y, x = vdata, use = "pair"), 2)
```

### Section 7.1.7 Generating the imputations

```{r, eval=FALSE}
### Smart imputation using quickpred - - TIME CONSUMING 
### (30 MINUTES)
imp.qp <- mice(data2, pred = pred, ridge = 1e-04, seed = 29725)

### Blind imputation - MUCH MORE TIME CONSUMING (10
### HOURS) Not recommended
imp <- mice(data, ridge = 0.01, seed = 32417, maxit = 2)

vnames <- c("rrsyst", "rrdiast")
cd1 <- complete(imp)[, vnames]
cd2 <- complete(imp.qp)[, vnames]
typ <- factor(rep(c("blind imputation", "quickpred"), 
  each = nrow(cd1)))
mis <- ici(data2[, vnames])
mis <- is.na(imp$data$rrsyst) | is.na(imp$data$rrdiast)
cd <- data.frame(typ = typ, mis = mis, rbind(cd1, cd2))
tp72 <- xyplot(jitter(rrdiast, 10) ~ jitter(rrsyst, 
  10) | typ, data = cd, groups = mis, xlab = "Systolic BP (mmHg)", 
  ylab = "Diastolic BP (mmHg)", col = c(mdc(1), mdc(2)), 
  pch = c(1, 19), type = c("g", "p"), strip = strip.custom(bg = "grey95"), 
  scales = list(alternating = 1, tck = c(1, 0)))
print(tp72)
```

### Section 7.1.8 A further improvements: Survival as
### predictor variable

```{r, eval=FALSE}
dat <- cbind(data2, dead = 1 - data2$dwa)
hazard <- nelsonaalen(dat, survda, dead)

### calculate correlations between hazard, t and logt
### (not in
tmp <- data.frame(hazard, t = data2$survda, logt = log(data2$survda), 
  SBP = data2$rrsyst, DBP = data2$rrdiast)
round(cor(tmp, use = "pair"), 3)
```

### Section 7.2 Sensitivity analysis

### Figure 7.3

```{r, eval=FALSE}
fit <- survfit(Surv(survda/365, 1 - dwa) ~ is.na(rrsyst), 
  data = data2)
plot(fit, lty = 1, lwd = 1.5, xlab = "Years since intake", 
  ylab = "K-M Survival probability", las = 1, col = c(mdc(4), 
    mdc(5)), mark.time = FALSE)
text(4, 0.7, "BP measured")
text(2, 0.3, "BP missing")
```

### Section 7.2.3 Generating imputations under the
### delta-adjustment
```{r, eval=FALSE}
delta <- c(0, -5, -10, -15, -20)
post <- imp.qp$post

### undamped sensitivity analysis TIME CONSUMING
### (SEVERAL HOURS)
imp.all.undamped <- vector("list", length(delta))
for (i in 1:length(delta)) {
  d <- delta[i]
  cmd <- paste("imp[[j]][,i] <- imp[[j]][,i] +", 
    d)
  post["rrsyst"] <- cmd
  imp <- mice(data2, pred = pred, post = post, maxit = 1, 
    seed = i * 22, ridge = 1e-04)
  imp.all.undamped[[i]] <- imp
}

### damped sensitivity analysis TIME CONSUMING
### (SEVERAL HOURS)
imp.all.damped <- vector("list", length(delta))
for (i in 1:length(delta)) {
  d <- delta[i]
  cmd <- paste("fit <- lm(y ~ as.matrix(x)); 
        damp <- sqrt(1 - summary(fit)$r.squared);
        imp[[j]][, i] <- imp[[j]][, i] + damp * ", 
    d)
  post["rrsyst"] <- cmd
  imp <- mice(data2, pred = pred, post = post, maxit = 1, 
    seed = i * 22, ridge = 1e-04)
  imp.all.damped[[i]] <- imp
}
```

### Section 7.2.4 Complete data analysis

```{r, eval=FALSE}
cda <- expression(sbpgp <- cut(rrsyst, breaks = c(50, 
  124, 144, 164, 184, 200, 500)), agegp <- cut(lftanam, 
  breaks = c(85, 90, 95, 110)), dead <- 1 - dwa, 
  coxph(Surv(survda, dead) ~ C(sbpgp, contr.treatment(6, 
    base = 3)) + strata(sexe, agegp)))
imp <- imp.all.damped[[1]]
fit <- with(imp, cda)
as.vector(exp(summary(pool(fit))[, 1]))

### Table 7.5

fit1 <- with(imp.all.damped[[1]], cda)
fit2 <- with(imp.all.damped[[2]], cda)
fit3 <- with(imp.all.damped[[3]], cda)
fit4 <- with(imp.all.damped[[4]], cda)
fit5 <- with(imp.all.damped[[5]], cda)
r1 <- as.vector(t(exp(summary(pool(fit1))[, c(1, 6:7)])))
r2 <- as.vector(t(exp(summary(pool(fit2))[, c(1, 6:7)])))
r3 <- as.vector(t(exp(summary(pool(fit3))[, c(1, 6:7)])))
r4 <- as.vector(t(exp(summary(pool(fit4))[, c(1, 6:7)])))
r5 <- as.vector(t(exp(summary(pool(fit5))[, c(1, 6:7)])))
round(t(matrix(c(r1, r2, r3, r4, r5), nrow = 15)), 
  2)
```


### Section 7.3 Correct prevalence estimates from
### self-reported data

```{r}
library("mice")
krul <- selfreport[selfreport$src == "krul", ]
mgg <- selfreport[selfreport$src == "mgg", ]

### Figure 7.4

xy <- xy.coords(krul$bm, krul$br - krul$bm)
plot(xy, col = mdc(1), xlab = "Measured BMI", ylab = "Reported - Measured BMI", 
  xlim = c(17, 45), ylim = c(-5, 5), type = "n", 
  lwd = 0.7)
polygon(x = c(30, 20, 30), y = c(0, 10, 10), col = "grey95", 
  border = NA)
polygon(x = c(30, 40, 30), y = c(0, -10, -10), col = "grey95", 
  border = NA)
abline(0, 0, lty = 2, lwd = 0.7)
points(xy, col = mdc(1), cex = 0.7)
lines(lowess(xy), lwd = 2, col = mdc(4))
text(1:4, x = c(40, 28, 20, 32), y = c(4, 4, -4, -4), 
  cex = 3)
box(lwd = 1)
```

### Figure 7.5 Krul data - males

```{r}
males <- krul[krul$sex == "Male", ]
fit <- lm(bm ~ br, data = males)
plot(x = males$br, y = males$bm, xlim = c(26, 34), 
  ylim = c(26, 34), xlab = "Self-reported BMI", ylab = "Measured BMI", 
  col = mdc(1), cex.lab = 1.5, cex.axis = 1.3)
abline(h = 30, v = 30, lty = 2)
abline(coef(fit), col = mdc(4))
abline(v = (30 - coef(fit)[1])/coef(fit)[2], col = mdc(4))
text(1:4, x = c(33.8, 33.8, 26.2, 26.2), y = c(33.8, 
  26.2, 26.2, 33.8), cex = 4)
text(c("a", "b"), x = c(29.1, 29.7, 29.1, 29.7), y = c(34.1, 
  34.1, 26.4, 26.4), cex = 3, adj = c(0.5, 1))
```

### Section 7.3.4 Data

```{r}
md.pattern(selfreport[, c("age", "sex", "hm", "hr", 
  "wm", "wr")])
```

### Section 7.3.5 Application

```{r}
bmi <- function(h, w) w/(h/100)^2
init <- mice(selfreport, maxit = 0)
meth <- init$meth
meth["bm"] <- "~bmi(hm,wm)"
meth[c("prg", "edu", "etn")] <- ""
pred <- init$pred
pred[, c("src", "id", "pop", "prg", "edu", "etn", "web", 
  "bm", "br")] <- 0
imp <- mice(selfreport, pred = pred, meth = meth, seed = 66573, 
  maxit = 20, m = 10)
```

### Figure 7.6

```{r}
cd <- complete(imp, 1)
xy <- xy.coords(cd$bm, cd$br - cd$bm)
plot(xy, col = mdc(2), xlab = "Measured BMI", ylab = "Reported - Measured BMI", 
  xlim = c(17, 45), ylim = c(-5, 5), type = "n", 
  lwd = 0.7)
polygon(x = c(30, 20, 30), y = c(0, 10, 10), col = "grey95", 
  border = NA)
polygon(x = c(30, 40, 30), y = c(0, -10, -10), col = "grey95", 
  border = NA)
abline(0, 0, lty = 2, lwd = 0.7)

idx <- cd$src == "krul"
xyc <- xy
xyc$x <- xy$x[idx]
xyc$y <- xy$y[idx]
xys <- xy
xys$x <- xy$x[!idx]
xys$y <- xy$y[!idx]
points(xyc, col = mdc(1), cex = 0.7)
points(xys, col = mdc(2), cex = 0.7)
lines(lowess(xyc), col = mdc(4), lwd = 2)
lines(lowess(xys), col = mdc(5), lwd = 2)
text(1:4, x = c(40, 28, 20, 32), y = c(4, 4, -4, -4), 
  cex = 3)
box(lwd = 1)
```

### Table 7.7 

```{r}
### Not particularly elegant code, at the moment
prev <- matrix(NA, nr = 15, nc = 4)
prev[1, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg")))))[1, 1:2]
prev[1, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg")))))[1, 1:2]
prev[2, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male")))))[1, 
  1:2]
prev[2, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male")))))[1, 
  1:2]
prev[3, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female")))))[1, 
  1:2]
prev[3, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female")))))[1, 
  1:2]
prev[4, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age >= 
  18 & age < 30)))))[1, 1:2]
prev[4, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age > 
  18 & age < 30)))))[1, 1:2]
prev[5, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age >= 
  30 & age < 40)))))[1, 1:2]
prev[5, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age > 
  30 & age < 40)))))[1, 1:2]
prev[6, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age >= 
  40 & age < 50)))))[1, 1:2]
prev[6, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age > 
  40 & age < 50)))))[1, 1:2]
prev[7, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age >= 
  50 & age < 60)))))[1, 1:2]
prev[7, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age > 
  50 & age < 60)))))[1, 1:2]
prev[8, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age >= 
  60 & age < 80)))))[1, 1:2]
prev[8, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Male" & age > 
  60 & age < 80)))))[1, 1:2]
prev[10, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age >= 
  18 & age < 30)))))[1, 1:2]
prev[10, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age > 
  18 & age < 30)))))[1, 1:2]
prev[11, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age >= 
  30 & age < 40)))))[1, 1:2]
prev[11, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age > 
  30 & age < 40)))))[1, 1:2]
prev[12, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age >= 
  40 & age < 50)))))[1, 1:2]
prev[12, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age > 
  40 & age < 50)))))[1, 1:2]
prev[13, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age >= 
  50 & age < 60)))))[1, 1:2]
prev[13, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age > 
  50 & age < 60)))))[1, 1:2]
prev[14, 1:2] <- summary(pool(with(imp, lm(br >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age >= 
  60 & age < 80)))))[1, 1:2]
prev[14, 3:4] <- summary(pool(with(imp, lm(bm >= 30 ~ 
  1, subset = (src == "mgg" & sex == "Female" & age > 
  60 & age < 80)))))[1, 1:2]

### find group sizes
table(mgg$sex, mgg$web)
table(mgg$sex, mgg$web, mgg$age > 55)
```

### Section 7.4 Enhancing comparability

```{r}
library("mice")

### Section 7.4.3 Independence: Imputation without a
### bridge study

fA <- c(242, 43, 15, 0, 6)
fB <- c(145, 110, 29, 8)
YA <- rep(ordered(c(0:3, NA)), fA)
YB <- rep(ordered(c(0:3)), fB)
Y <- rbind(data.frame(YA, YB = ordered(NA)), data.frame(YB, 
  YA = ordered(NA)))

md.pattern(Y)

### simulation function Warning: micemill()
### overwrites objects 'imp' and 'tau' in the global
### enviroment

micemill <- function(n) {
  for (i in 1:n) {
    imp <<- mice.mids(imp)  # global assignment 
    cors <- with(imp, cor(as.numeric(YA), as.numeric(YB), 
      method = "kendall"))
    tau <<- rbind(tau, getfit(cors, s = TRUE))  # global assignment
  }
}

tau <- NULL
imp <- mice(Y, max = 0, m = 10, seed = 32662)
micemill(50)

### Figure 7.7
plotit <- function() matplot(x = 1:nrow(tau), y = tau, 
  ylab = expression(paste("Kendall's ", tau)), xlab = "Iteration", 
  type = "l", lwd = 1, lty = 1:10, col = "black")
plotit()
```

### Section 7.4.4 Fully dependent or independent?

```{r}
### Use the 'walking' dataset of the mice package

## split walking: ab is sources A and B (598
## records)
ab <- walking[walking$src == "A" | walking$src == "B", ]

## split walking: euridiss is external source (292
## records)
external <- walking[walking$src == "E", ]

### create contingency tables: YA by YB (in ab)
ftable(addmargins(table(ab[, c("YA", "YB")], useNA = "ifany")))

### Table 7.8 contingency table YA by YB (in
### euridiss)
ftable(addmargins(table(external[, c("YA", "YB")], 
  useNA = "ifany")))

### Section 7.4.5 Imputation using a bridge study
md.pattern(walking)

### Figure 7.8
tau <- NULL
imp <- mice(walking, max = 0, m = 10, seed = 92786)
pred <- imp$pred
pred[, c("src", "age", "sex")] <- 0
imp <- mice(walking, max = 0, m = 10, seed = 92786, 
  pred = pred)
micemill(20)
plotit()
```

### impute without and with covariates

```{r}
thetaAB <- NULL
props <- with(imp, mean(YB[src == "A"] == "0"))
thetaAB <<- rbind(thetaAB, getfit(props, s = TRUE))

micemill <- function(n) {
  for (i in 1:n) {
    imp <<- mice.mids(imp)  # global assignment 
    cors <- with(imp, cor(as.numeric(YA[src == 
      "A"]), as.numeric(YB[src == "A"]), method = "kendall"))
    tau <<- rbind(tau, getfit(cors, s = TRUE))  # global assignment
    means <- with(imp, mean(as.numeric(YA[src == 
      "A"]), na.rm = TRUE))
    thetaBA <<- rbind(thetaBA, getfit(means, s = TRUE) - 
      1)
    props <- with(imp, mean(YB[src == "A"] == "0"))
    thetaAB <<- rbind(thetaAB, getfit(props, s = TRUE))
    tabs <- with(imp, ftable(addmargins(table(YA[src == 
      "A"], YB[src == "A"], useNA = "ifany", 
      dnn = c("YA", "YB")))))
    print(getfit(tabs)[[2]])
  }
}

tau <- NULL
thetaBA <- NULL
thetaAB <- NULL
imp <- mice(walking, max = 0, m = 10, seed = 99786)
oldpred <- pred <- imp$pred
pred[, c("src", "age", "sex")] <- 0
imp <- mice(walking, max = 0, m = 10, seed = 99786, 
  pred = pred)
micemill(20)
pred <- oldpred
pred[, c("src")] <- 0
imp <- mice(walking, max = 0, m = 10, pred = pred)
micemill(20)

### Figure 7.9

matplot(x = 1:nrow(thetaAB), y = thetaAB, xlab = "Iteration", 
  ylab = expression(hat(theta)[AB]), type = "l", 
  lwd = 1, lty = 1:10, col = "black", ylim = c(0.4, 
    0.7))
abline(h = 0.497, v = 20, lty = 2)
text(x = 5, y = 0.488, expression(hat(theta)[BB]), 
  adj = 0)
text(x = 5, y = 0.43, "Without covariates", adj = 0)
text(x = 25, y = 0.43, "With covariates", adj = 0)
arrows(x0 = 4.5, y0 = 0.488, x1 = 0, y1 = 0.495, length = 0.1, 
  angle = 20)
points(x = -0.4, y = 0.497, pch = 20)

## file <-
## file.path('~/Documents/Sync/Impute/mice/V2.12/mice/data/walking.rda')
## save(walking, file=file)

## selfreport <- nl file <-
## file.path('~/Documents/Sync/Impute/mice/V2.12/mice/data/selfreport.rda')
## save(selfreport, file=file)

```

